// This tells Prisma how to generate the database client
generator client {
    provider = "prisma-client-js"
}

// This connects to your PostgreSQL database
datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
}

// User table - stores user accounts and subscription info
// User table - stores user accounts and subscription info
model User {
    id           String   @id @default(cuid())
    email        String   @unique
    passwordHash String
    name         String?
    createdAt    DateTime @default(now())
    updatedAt    DateTime @updatedAt

    // Stripe subscription fields
    stripeCustomerId     String?   @unique
    stripeSubscriptionId String?   @unique
    subscriptionTier     String    @default("free")
    subscriptionStatus   String    @default("active")
    billingInterval      String? // 'monthly' | 'yearly'
    currentPeriodEnd     DateTime?

    // Usage tracking
    downloadsThisMonth   Int       @default(0)
    generationsThisMonth Int       @default(0) // ✅ ADD THIS LINE
    lastResetDate        DateTime  @default(now())
    patterns             Pattern[] // ✅ Add this line if missing

    // Quilter profile
    skillLevel    String         @default("beginner") // beginner, advanced_beginner, intermediate, advanced, expert
    badge         String? // 'tester' or 'founder'
    feedbacks     Feedback[]
    feedbackVotes FeedbackVote[]

    // Password reset
    resetToken       String?
    resetTokenExpiry DateTime?

    @@map("users")
}

model Pattern {
    id           String    @id @default(cuid())
    userId       String
    patternData  Json // Stores the AI-generated pattern
    patternType  String? // e.g., "nine-patch", "log-cabin"
    patternName  String? // Display name like "Nine Patch"
    fabricColors Json? // Store fabric color info for thumbnails
    downloaded   Boolean   @default(false)
    downloadedAt DateTime?
    createdAt    DateTime  @default(now())

    user User @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@index([userId, downloaded])
    @@index([downloaded, createdAt])
    @@map("patterns")
}

// Feedback / roadmap suggestions
model Feedback {
    id          String   @id @default(cuid())
    title       String
    description String?
    authorId    String? // Optional link to User
    votesCount  Int      @default(0)
    resolved    Boolean  @default(false)
    createdAt   DateTime @default(now())

    author User?          @relation(fields: [authorId], references: [id], onDelete: SetNull)
    votes  FeedbackVote[]

    @@map("feedback")
}

model FeedbackVote {
    id         String   @id @default(cuid())
    userId     String
    feedbackId String
    createdAt  DateTime @default(now())

    user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
    feedback Feedback @relation(fields: [feedbackId], references: [id], onDelete: Cascade)

    @@unique([userId, feedbackId])
    @@map("feedback_votes")
}
